<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rexy Pong: Zen Survival</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* --- CORE STYLES --- */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        overflow: hidden; background-color: #020205;
        font-family: 'Press Start 2P', cursive;
        user-select: none; -webkit-user-select: none;
        touch-action: none;
        position: fixed; /* Fix for mobile height issues */
    }

    #game-container {
        position: absolute; top: 0; left: 0; 
        width: 100vw; 
        /* Height set via JS */
        background: #000; overflow: hidden;
        display: flex; justify-content: center; align-items: center;
    }

    canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; z-index: 1; }

    /* SOFT CRT OVERLAY */
    #scanlines {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
        background-size: 100% 3px, 3px 100%;
        pointer-events: none; z-index: 5; opacity: 0.3;
    }

    /* CYBER UI LAYER */
    .ui-layer { 
        position: absolute; top: 20px; width: 100%; 
        display: flex; justify-content: space-between; align-items: flex-start;
        padding: 0 20px; box-sizing: border-box; 
        pointer-events: none; z-index: 10; 
        color: white; text-shadow: 0 0 10px rgba(0,0,0,0.8); 
    }
    
    .score-group { display: flex; gap: 20px; }
    .score-box { text-align: center; opacity: 0.9; }
    .score-label { font-size: 10px; color: #888; margin-bottom: 5px; display: block; letter-spacing: 2px; }
    .score-val { font-size: 20px; font-weight: bold; }

    .rex-box {
        background: rgba(0,0,0,0.6);
        border: 2px solid #FFD700;
        padding: 8px 15px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        backdrop-filter: blur(4px);
    }

    #hearts-display { color: #ff4444; font-size: 16px; letter-spacing: 2px; text-shadow: 0 0 10px red; }

    #mute-btn { position: absolute; bottom: 20px; right: 20px; z-index: 30; background: rgba(0,0,0,0.6); border: 1px solid #555; color: #888; padding: 10px; font-size: 10px; cursor: pointer; pointer-events: auto; border-radius: 4px; transition: 0.2s; }
    #mute-btn:hover { border-color: #fff; color: #fff; }

    /* SCREENS */
    #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }

    #ban-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(20, 0, 0, 0.95); color: #ff5555;
        border: 20px solid #500; box-sizing: border-box;
        display: none; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; z-index: 1000;
    }

    /* --- MOBILE ORIENTATION FIX --- */
    #rotate-message {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #020205; z-index: 9999; flex-direction: column;
        justify-content: center; align-items: center; text-align: center; color: #00ff9d;
    }
    @media screen and (orientation: portrait) {
        #rotate-message { display: flex; }
        #game-container { visibility: hidden; }
    }
  </style>
</head>
<body>

<div id="rotate-message">
    <div style="font-size: 40px; margin-bottom: 20px;">↻</div>
    <div style="font-size: 14px; line-height: 1.5; padding: 0 20px;">
        PLEASE ROTATE DEVICE<br>FOR ZEN MODE
    </div>
</div>

<div id="game-container">
    <div id="scanlines"></div>

    <div class="ui-layer">
        <div class="score-group">
            <div class="score-box" style="text-align: left;">
                <span class="score-label" style="color:#ff4444">LIVES</span>
                <span id="hearts-display">❤❤❤❤❤</span>
            </div>
            <div class="score-box">
                <span class="score-label" style="color:#00ff9d">YOU</span>
                <span id="p-score" class="score-val" style="color:#00ff9d">0</span>
            </div>
        </div>

        <div class="score-box rex-box">
            <span style="color:#FFD700; font-size: 10px; display:block; margin-bottom:5px;">EARNINGS</span>
            <span style="color:#FFD700; font-size: 16px;">$REX: <span id="rex-score">0</span></span>
        </div>

        <div class="score-box">
            <span class="score-label" style="color:#ff0055">AI</span>
            <span id="ai-score" class="score-val" style="color:#ff0055">0</span>
        </div>
    </div>

    <div id="start-screen">
        <h1 id="screen-title" style="color: #00ff9d; margin-bottom: 20px; font-size: 40px; text-shadow: 0 0 20px #00ff9d; letter-spacing: -2px; text-align:center;">REXY PONG</h1>
        <div style="width: 200px; height: 2px; background: #fff; margin-bottom: 30px;"></div>
        <p id="screen-msg" style="color: #ccc; font-size: 12px; margin-bottom: 50px; line-height: 2; text-align: center;">
            <span style="color: #FFD700;">COLLECT TOKENS • SURVIVE</span><br>
            YOU HAVE 5 LIVES<br><br>
            <span style="border: 2px solid white; padding: 10px 20px; display: inline-block; animation: blink 2s infinite; cursor: pointer; color: #fff;">TAP TO START</span>
        </p>
    </div>

    <div id="ban-screen">
        <h1 style="color:red; font-size: 40px; margin-bottom:20px; text-shadow: 0 0 20px red;">SYSTEM LOCKDOWN</h1>
        <div style="font-size: 14px; line-height: 2; border: 1px solid #ff5555; padding: 20px; background: #200;">
            SECURITY ALERT: <span id="ban-reason">UNAUTHORIZED ACCESS</span><br>
            SUSPICIOUS ACTIVITY DETECTED.
        </div>
    </div>

    <div id="mute-btn">SOUND: ON</div>
    <canvas id="pongCanvas"></canvas>
</div>

<script>
(function() {
    // --- SECURITY LAYER ---
    window.godMode = false; window.infiniteAmmo = false;
    let _s0x = 0; let _p0x = 0; let _a0x = 0; let _lastTokenTime = 0;
    
    // Game State
    let lives = 5;
    const maxLives = 5;

    if (localStorage.getItem('rexy_ban_status') === 'banned') { triggerBan("PRIOR OFFENSE DETECTED"); return; }
    function triggerBan(reason) {
        document.getElementById('ban-screen').style.display = 'flex';
        document.getElementById('ban-reason').innerText = reason;
        document.getElementById('start-screen').style.display = 'none';
        localStorage.setItem('rexy_ban_status', 'banned');
        gameState = 'BANNED';
        window.cancelAnimationFrame(animationFrameId);
        stopMusic();
    }

    // --- ASSETS ---
    const assets = { token: { src: "rex-token.png", img: new Image() }, rexy: { src: "rexy-run-sheet.png", img: new Image() } };
    Object.values(assets).forEach(a => { if(a.src) a.img.src = a.src; });

    // --- SETUP ---
    const canvas = document.getElementById("pongCanvas");
    const container = document.getElementById("game-container");
    const ctx = canvas.getContext("2d");
    let W, H;
    let animationFrameId;

    function resize() {
        // --- MOBILE ASPECT RATIO FIX ---
        W = window.innerWidth;
        H = window.innerHeight;

        container.style.width = W + 'px';
        container.style.height = H + 'px';
        
        canvas.width = W;
        canvas.height = H;
        ctx.imageSmoothingEnabled = false;

        if (typeof ai !== 'undefined') {
             ai.x = W - 50;
             ai.y = Math.min(ai.y, H - ai.h);
        }
        initBackgrounds();
    }
    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', () => { setTimeout(resize, 200); });

    // --- GAME STATE ---
    let gameState = 'MENU';
    let shake = 0;

    // --- BACKGROUND SYSTEM (CROSS FADE) ---
    let bgMode = 0; 
    let bgTimer = 0;
    let fadeProgress = 0; 

    let stars = []; let rain = []; let bubbles = [];

    function initBackgrounds() {
        stars = []; for(let i=0; i<80; i++) stars.push({x: Math.random()*W, y: Math.random()*H, size: Math.random() * 2, speed: Math.random() * 0.5 + 0.1});
        rain = []; for(let i=0; i<60; i++) rain.push({x: Math.random()*W, y: Math.random()*H, len: Math.random() * 20 + 5, speed: Math.random() * 2 + 1, opacity: Math.random() * 0.3});
        bubbles = []; for(let i=0; i<15; i++) bubbles.push({x: Math.random()*W, y: Math.random()*H, r: Math.random() * 50 + 20, speed: Math.random() * 0.5 + 0.1, opacity: Math.random() * 0.1});
    }

    function updateBackgroundLogic() {
        stars.forEach(s => { s.x -= s.speed; if(s.x < 0) s.x = W; });
        rain.forEach(r => { r.y += r.speed; if(r.y > H) r.y = -r.len; });
        bubbles.forEach(b => { b.y -= b.speed; if(b.y < -b.r) b.y = H + b.r; });

        bgTimer++;
        if(bgTimer > 1200) { 
            fadeProgress += 0.005;
            if(fadeProgress >= 1) {
                bgMode = (bgMode + 1) % 3;
                fadeProgress = 0; bgTimer = 0;
            }
        }
    }

    function drawLayer(mode, alpha) {
        ctx.save(); ctx.globalAlpha = alpha;
        if (mode === 0) {
            ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
            stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); });
        }
        else if (mode === 1) {
            ctx.fillStyle = "rgba(0, 255, 100, 0.15)";
            rain.forEach(r => { ctx.fillRect(r.x, r.y, 2, r.len); });
        }
        else if (mode === 2) {
            bubbles.forEach(b => {
                ctx.fillStyle = "rgba(100, 100, 255, " + b.opacity + ")";
                ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
            });
        }
        ctx.restore();
    }

    function drawBackground() {
        updateBackgroundLogic();
        ctx.fillStyle = '#020205'; ctx.fillRect(-20, -20, W+40, H+40);
        drawLayer(bgMode, 1.0 - fadeProgress);
        if (fadeProgress > 0) { let nextMode = (bgMode + 1) % 3; drawLayer(nextMode, fadeProgress); }

        if (bgTimer < 150 && fadeProgress === 0) {
            let text = "";
            if (bgMode === 0) text = "ZONE: DEEP SPACE";
            if (bgMode === 1) text = "ZONE: DATA STREAM";
            if (bgMode === 2) text = "ZONE: ETHER REALM";
            ctx.save(); ctx.globalAlpha = (150 - bgTimer) / 150; ctx.fillStyle = "#555"; ctx.font = "12px 'Press Start 2P'"; ctx.textAlign = "center"; ctx.fillText(text, W/2, H - 50); ctx.restore();
        }
    }

    // --- GAME OBJECTS ---
    const paddleH = 100; const paddleW = 20;
    const player = { x: 30, y: 0, w: paddleW, h: paddleH, color: '#00ff9d' };
    const ai = { x: 0, y: 0, w: paddleW, h: paddleH, color: '#ff0055', speed: 6 };
    const ball = { x: 0, y: 0, r: 8, speed: 5, dx: 5, dy: 3, color: '#fff', trail: [] };
    let particles = [];
    let activeToken = null; let tokenTimer = 0; let nextTokenTime = 50;

    // --- AUDIO & MUSIC ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = false;

    // 1. SOUND EFFECTS
    const sfx = {
        beep: (f, t, vol=0.1) => {
            if(isMuted || audioCtx.state === 'suspended') return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.frequency.value = f; o.type=t; g.gain.value=vol;
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.1);
        },
        hit: () => sfx.beep(600, 'square', 0.1),
        wall: () => sfx.beep(200, 'sine', 0.1),
        score: () => sfx.beep(150, 'sawtooth', 0.2),
        coin: () => sfx.beep(1200, 'sine', 0.15),
        over: () => sfx.beep(100, 'sawtooth', 0.5)
    };

    // 2. ZEN MUSIC ENGINE
    let musicInterval = null;
    let noteIdx = 0;
    // An ethereal, pentatonic chime melody
    const zenMelody = [
        392.00, 0, 329.63, 0, // G4, E4
        523.25, 0, 392.00, 0, // C5, G4
        587.33, 0, 523.25, 0, // D5, C5
        659.25, 0, 0, 0       // E5, rest
    ];

    function playZenNote(freq) {
        if (isMuted || audioCtx.state === 'suspended') return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine'; // Sine wave for "glassy" sound
        o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        // Envelope: Soft attack, Long release
        g.gain.setValueAtTime(0, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.1); 
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2.0);

        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 2.0);
    }

    function startMusic() {
        if(musicInterval) clearInterval(musicInterval);
        noteIdx = 0;
        // Play a note every 500ms for a slow, relaxing tempo
        musicInterval = setInterval(() => {
            const freq = zenMelody[noteIdx % zenMelody.length];
            if(freq > 0) playZenNote(freq);
            noteIdx++;
        }, 500);
    }

    function stopMusic() {
        if(musicInterval) clearInterval(musicInterval);
        musicInterval = null;
    }

    function spawnParticles(x, y, color, count=10) {
        for(let i=0; i<count; i++) {
            particles.push({x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1.0, color: color, size: Math.random() * 4 + 1});
        }
    }

    function drawPaddle(p, color) {
        ctx.fillStyle = '#111'; ctx.fillRect(p.x + 5, p.y + 10, p.w - 10, p.h - 20); // Core
        ctx.fillStyle = color; ctx.shadowBlur = 10; ctx.shadowColor = color;
        ctx.fillRect(p.x, p.y, p.w, 10); // Cap
        ctx.fillRect(p.x, p.y + p.h - 10, p.w, 10); // Cap
        if (p === player) ctx.fillRect(p.x + p.w - 5, p.y, 5, p.h); // Edge
        else ctx.fillRect(p.x, p.y, 5, p.h); // Edge
        ctx.shadowBlur = 0;
    }

    function updateHeartsUI() {
        let h = "";
        for(let i=0; i<lives; i++) h += "❤";
        document.getElementById('hearts-display').innerText = h;
    }

    function gameOver() {
        gameState = 'MENU';
        stopMusic(); // Stop music on death
        sfx.over();
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('screen-title').innerText = "GAME OVER";
        document.getElementById('screen-title').style.color = "#ff4444";
        document.getElementById('screen-msg').innerHTML = 
            `FINAL EARNINGS: <span style="color:#FFD700">$REX ${_s0x}</span><br>
             SCORE: ${_p0x}<br><br>
             <span style="border: 2px solid white; padding: 10px 20px; display: inline-block; animation: blink 2s infinite; cursor: pointer; color: #fff;">TAP TO RETRY</span>`;
    }

    // --- GAME LOOP ---
    function resetBall() {
        ball.x = W/2; ball.y = H/2; ball.speed = 5; ball.trail = [];
        let dirX = (ball.dx > 0) ? -1 : 1;
        ball.dx = dirX * ball.speed; ball.dy = (Math.random() * 4) - 2;
    }

    function spawnToken() {
        const marginX = W * 0.25; const marginY = H * 0.15;
        activeToken = { x: marginX + Math.random() * (W - marginX*2), y: marginY + Math.random() * (H - marginY*2), size: 40 };
    }

    function update() {
        if (gameState !== 'PLAY') return;
        if (shake > 0) shake *= 0.9; if (shake < 0.5) shake = 0;

        // Security
        if(window.godMode || window.infiniteAmmo) { triggerBan("CHEAT VAR DETECTED"); return; }

        // AI
        const targetY = ball.y - (ai.h / 2);
        if (Math.random() < 0.92) { if (targetY > ai.y + 10) ai.y += ai.speed; else if (targetY < ai.y - 10) ai.y -= ai.speed; }

        player.y = Math.max(0, Math.min(H - player.h, player.y));
        ai.y = Math.max(0, Math.min(H - ai.h, ai.y));

        ball.x += ball.dx; ball.y += ball.dy;
        ball.trail.push({x: ball.x, y: ball.y}); if(ball.trail.length > 15) ball.trail.shift();

        if (ball.y + ball.r > H || ball.y - ball.r < 0) { ball.dy = -ball.dy; sfx.wall(); spawnParticles(ball.x, ball.y, '#fff', 5); }

        let paddle = (ball.x < W/2) ? player : ai;
        if (ball.x - ball.r < paddle.x + paddle.w && ball.x + ball.r > paddle.x && ball.y > paddle.y && ball.y < paddle.y + paddle.h) {
            let collidePoint = (ball.y - (paddle.y + paddle.h/2)) / (paddle.h/2);
            let angle = collidePoint * (Math.PI/4);
            let direction = (ball.x < W/2) ? 1 : -1;
            if(ball.speed < 18) ball.speed += 0.5;
            ball.dx = direction * ball.speed * Math.cos(angle);
            ball.dy = ball.speed * Math.sin(angle);
            sfx.hit(); shake = 5; spawnParticles(ball.x, ball.y, paddle.color, 15);
        }

        if (activeToken) {
            const dx = ball.x - (activeToken.x + activeToken.size/2); const dy = ball.y - (activeToken.y + activeToken.size/2);
            if (Math.sqrt(dx*dx + dy*dy) < activeToken.size/2 + ball.r) {
                const now = Date.now(); if (now - _lastTokenTime < 50) { }
                else {
                    _lastTokenTime = now;
                    _s0x += 1; document.getElementById('rex-score').innerText = _s0x;
                    spawnParticles(activeToken.x + 20, activeToken.y + 20, '#FFD700', 20); activeToken = null; tokenTimer = 0; nextTokenTime = 80 + Math.random() * 150; sfx.coin();
                }
            }
        } else { tokenTimer++; if(tokenTimer > nextTokenTime) spawnToken(); }

        // --- SCORING & LIVES ---
        if (ball.x > W) { 
            // Player Scores
            _p0x++; 
            document.getElementById('p-score').innerText = _p0x; 
            sfx.score(); shake = 10; resetBall(); 
        }
        else if (ball.x < 0) { 
            // AI Scores / Player loses life
            _a0x++; 
            document.getElementById('ai-score').innerText = _a0x; 
            sfx.score(); shake = 10; 
            
            // LIVES LOGIC
            lives--;
            updateHeartsUI();
            
            if (lives <= 0) {
                gameOver();
            } else {
                // Instantly respawn
                resetBall();
            }
        }

        for(let i = particles.length - 1; i >= 0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05; if(p.life <= 0) particles.splice(i, 1); }
    }

    function draw() {
        if(gameState === 'BANNED') return;
        let dx = (Math.random() - 0.5) * shake; let dy = (Math.random() - 0.5) * shake;
        ctx.save(); ctx.translate(dx, dy);

        drawBackground(); 

        particles.forEach(p => { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, p.size, p.size); });
        ctx.globalAlpha = 1.0;

        if (activeToken) {
            const pulse = Math.sin(Date.now() / 150) * 5;
            if(assets.token.img.complete) { ctx.shadowBlur = 20; ctx.shadowColor = '#FFD700'; ctx.drawImage(assets.token.img, activeToken.x - pulse, activeToken.y - pulse, activeToken.size + (pulse*2), activeToken.size + (pulse*2)); ctx.shadowBlur = 0; }
            else { ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(activeToken.x + 20, activeToken.y + 20, 15 + pulse, 0, Math.PI*2); ctx.fill(); }
        }

        drawPaddle(player, player.color);
        drawPaddle(ai, ai.color);

        ball.trail.forEach((pos, i) => { ctx.fillStyle = `rgba(255, 255, 255, ${i/15})`; ctx.beginPath(); ctx.arc(pos.x, pos.y, ball.r * (i/15), 0, Math.PI*2); ctx.fill(); });
        ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff'; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;

        ctx.restore();
        animationFrameId = requestAnimationFrame(() => { update(); draw(); });
    }

    // --- INPUTS ---
    canvas.addEventListener('mousemove', (e) => { if (gameState !== 'PLAY') return; const rect = canvas.getBoundingClientRect(); const rootY = e.clientY - rect.top; const scaleY = H / rect.height; player.y = (rootY * scaleY) - (player.h / 2); });
    canvas.addEventListener('touchmove', (e) => { if (gameState !== 'PLAY') return; e.preventDefault(); const rect = canvas.getBoundingClientRect(); const rootY = e.touches[0].clientY - rect.top; const scaleY = H / rect.height; player.y = (rootY * scaleY) - (player.h / 2); }, { passive: false });

    // --- UI ---
    const startScreen = document.getElementById('start-screen');
    startScreen.addEventListener('click', () => {
        if(gameState === 'BANNED') return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        startScreen.style.display = 'none';
        document.getElementById('screen-title').innerText = "REXY PONG";
        document.getElementById('screen-title').style.color = "#00ff9d";
        
        resize(); 
        ai.x = W - 50; ai.y = H/2 - 50; 
        
        // Reset Stats
        _s0x = 0; _p0x = 0; _a0x = 0;
        lives = 5;
        updateHeartsUI();

        document.getElementById('rex-score').innerText = '0'; 
        document.getElementById('p-score').innerText = '0'; 
        document.getElementById('ai-score').innerText = '0';
        
        gameState = 'PLAY';
        resetBall(); spawnToken();
        initBackgrounds(); 
        startMusic(); // START MUSIC
    });

    const muteBtn = document.getElementById('mute-btn');
    muteBtn.addEventListener('click', (e) => { e.stopPropagation(); isMuted = !isMuted; muteBtn.innerText = isMuted ? "SOUND: OFF" : "SOUND: ON"; if(isMuted) audioCtx.suspend(); else audioCtx.resume(); });

    // Init call
    resize();
    draw();
})();
</script>
</body>
</html>
